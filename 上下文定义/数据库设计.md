# FlashList 数据库设计文档

## 概述

本文档定义了FlashList极简大纲清单应用的数据库表结构设计。

**数据库类型**: MySQL 8.0+ / PostgreSQL 14+

---

## 表结构设计

### 1. users 表（用户表）

用户账户信息表

```sql
CREATE TABLE users (
  id VARCHAR(36) PRIMARY KEY COMMENT '用户ID (UUID)',
  username VARCHAR(50) NOT NULL UNIQUE COMMENT '用户名',
  email VARCHAR(100) NOT NULL UNIQUE COMMENT '邮箱',
  password_hash VARCHAR(255) NOT NULL COMMENT '密码哈希',
  avatar_url VARCHAR(255) COMMENT '头像URL',
  created_at BIGINT NOT NULL COMMENT '创建时间戳（毫秒）',
  updated_at BIGINT NOT NULL COMMENT '更新时间戳（毫秒）',
  last_login_at BIGINT COMMENT '最后登录时间戳（毫秒）',

  INDEX idx_email (email),
  INDEX idx_username (username)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='用户表';
```

---

### 2. flash_list_items 表（待办事项表）

核心待办事项数据表

```sql
CREATE TABLE flash_list_items (
  id VARCHAR(36) PRIMARY KEY COMMENT '待办事项ID (UUID)',
  user_id VARCHAR(36) NOT NULL COMMENT '所属用户ID',
  text TEXT NOT NULL DEFAULT '' COMMENT '任务或分类的文本内容',
  completed TINYINT(1) NOT NULL DEFAULT 0 COMMENT '完成状态 (0:未完成, 1:已完成)',
  level TINYINT NOT NULL DEFAULT 0 COMMENT '缩进级别 (0-4)',
  type ENUM('task', 'header') NOT NULL DEFAULT 'task' COMMENT '类型: task=任务, header=分类标题',
  order_index DECIMAL(10, 2) NOT NULL COMMENT '排序字段，支持小数以便插入',
  created_at BIGINT NOT NULL COMMENT '创建时间戳（毫秒）',
  updated_at BIGINT NOT NULL COMMENT '更新时间戳（毫秒）',
  deleted_at BIGINT DEFAULT NULL COMMENT '软删除时间戳（毫秒）',

  FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,

  INDEX idx_user_order (user_id, order_index),
  INDEX idx_user_type (user_id, type),
  INDEX idx_created_at (created_at),
  INDEX idx_deleted_at (deleted_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='待办事项表';
```

**字段说明**:

- `id`: UUID格式，前端生成或后端生成
- `user_id`: 用户ID，实现多用户数据隔离
- `text`: 支持空字符串，允许用户创建后再编辑
- `completed`: 仅对task类型有意义，header忽略此字段
- `level`: 范围0-4，控制缩进层级
- `type`: 区分任务和分类标题
- `order_index`: 使用DECIMAL类型，支持在两个item之间插入（如order 1和2之间插入1.5）
- `deleted_at`: 软删除标记，NULL表示未删除

---

### 3. sessions 表（会话表，可选）

如果使用session管理，可添加此表

```sql
CREATE TABLE sessions (
  id VARCHAR(36) PRIMARY KEY COMMENT '会话ID (UUID)',
  user_id VARCHAR(36) NOT NULL COMMENT '用户ID',
  token VARCHAR(255) NOT NULL UNIQUE COMMENT '访问令牌',
  refresh_token VARCHAR(255) COMMENT '刷新令牌',
  expires_at BIGINT NOT NULL COMMENT '过期时间戳（毫秒）',
  created_at BIGINT NOT NULL COMMENT '创建时间戳（毫秒）',
  last_activity_at BIGINT NOT NULL COMMENT '最后活动时间戳（毫秒）',

  FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,

  INDEX idx_token (token),
  INDEX idx_user_id (user_id),
  INDEX idx_expires_at (expires_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='会话表';
```

---

## 索引策略

### 主要查询场景

1. **按用户获取所有items**（最频繁）
   ```sql
   SELECT * FROM flash_list_items
   WHERE user_id = ? AND deleted_at IS NULL
   ORDER BY order_index ASC;
   ```
   - 使用复合索引：`idx_user_order (user_id, order_index)`

2. **按类型过滤**
   ```sql
   SELECT * FROM flash_list_items
   WHERE user_id = ? AND type = 'header' AND deleted_at IS NULL;
   ```
   - 使用复合索引：`idx_user_type (user_id, type)`

3. **软删除查询**
   - 所有查询都需要加上 `deleted_at IS NULL` 条件
   - 索引：`idx_deleted_at (deleted_at)`

---

## 数据约束

### 业务规则约束

1. **缩进级别**:
   ```sql
   ALTER TABLE flash_list_items
   ADD CONSTRAINT chk_level CHECK (level >= 0 AND level <= 4);
   ```

2. **完成状态**:
   ```sql
   ALTER TABLE flash_list_items
   ADD CONSTRAINT chk_completed CHECK (completed IN (0, 1));
   ```

3. **排序字段**:
   ```sql
   ALTER TABLE flash_list_items
   ADD CONSTRAINT chk_order_positive CHECK (order_index >= 0);
   ```

---

## 初始数据

### 示例用户数据

```sql
INSERT INTO users (id, username, email, password_hash, created_at, updated_at) VALUES
('user-uuid-001', 'demo_user', 'demo@example.com', '$2b$10$...', 1703001600000, 1703001600000);
```

### 示例待办事项数据

```sql
INSERT INTO flash_list_items (id, user_id, text, completed, level, type, order_index, created_at, updated_at) VALUES
-- 工作分类
('item-uuid-001', 'user-uuid-001', '工作', 0, 0, 'header', 0.00, 1703001600000, 1703001600000),
('item-uuid-002', 'user-uuid-001', '完成项目文档', 0, 1, 'task', 1.00, 1703001660000, 1703001660000),
('item-uuid-003', 'user-uuid-001', '代码审查', 0, 1, 'task', 2.00, 1703001720000, 1703001720000),
('item-uuid-004', 'user-uuid-001', '周会准备', 0, 2, 'task', 3.00, 1703001780000, 1703001780000),

-- 生活分类
('item-uuid-005', 'user-uuid-001', '生活', 0, 0, 'header', 4.00, 1703001840000, 1703001840000),
('item-uuid-006', 'user-uuid-001', '买菜', 0, 1, 'task', 5.00, 1703001900000, 1703001900000),
('item-uuid-007', 'user-uuid-001', '健身房', 1, 1, 'task', 6.00, 1703001960000, 1703001960000);
```

---

## 性能优化建议

### 1. 分页查询

对于item数量较多的用户，建议实现分页：

```sql
SELECT * FROM flash_list_items
WHERE user_id = ? AND deleted_at IS NULL
ORDER BY order_index ASC
LIMIT ? OFFSET ?;
```

### 2. 批量更新优化

拖拽排序时的批量更新，使用事务和批处理：

```sql
START TRANSACTION;

UPDATE flash_list_items SET order_index = 0, updated_at = ? WHERE id = ?;
UPDATE flash_list_items SET order_index = 1, updated_at = ? WHERE id = ?;
UPDATE flash_list_items SET order_index = 2, updated_at = ? WHERE id = ?;

COMMIT;
```

或使用 `CASE WHEN` 语句：

```sql
UPDATE flash_list_items
SET order_index = CASE
  WHEN id = 'item-uuid-001' THEN 0
  WHEN id = 'item-uuid-002' THEN 1
  WHEN id = 'item-uuid-003' THEN 2
END,
updated_at = ?
WHERE id IN ('item-uuid-001', 'item-uuid-002', 'item-uuid-003');
```

### 3. 软删除清理

定期清理软删除超过30天的数据：

```sql
DELETE FROM flash_list_items
WHERE deleted_at IS NOT NULL
  AND deleted_at < (UNIX_TIMESTAMP() * 1000 - 30 * 24 * 60 * 60 * 1000);
```

### 4. 连接池配置

建议配置：
- 最小连接数: 5
- 最大连接数: 20
- 连接超时: 30秒
- 空闲超时: 600秒

---

## 数据迁移方案

### 从localStorage迁移

前端localStorage数据格式：
```javascript
const localData = [
  {
    id: "uuid",
    text: "任务文本",
    completed: false,
    level: 1,
    type: "task",
    createdAt: 1703001600000
  }
];
```

迁移SQL生成示例：
```javascript
function generateMigrationSQL(userId, localData) {
  return localData.map((item, index) => ({
    id: item.id,
    user_id: userId,
    text: item.text,
    completed: item.completed ? 1 : 0,
    level: item.level,
    type: item.type,
    order_index: index,
    created_at: item.createdAt,
    updated_at: item.createdAt
  }));
}
```

---

## 备份策略

### 1. 定期备份
- 每日全量备份：凌晨2:00
- 每小时增量备份：保留24小时
- 每周归档备份：保留4周

### 2. 备份脚本示例
```bash
#!/bin/bash
# MySQL备份
mysqldump -u root -p flashlist_db > backup_$(date +%Y%m%d_%H%M%S).sql

# PostgreSQL备份
pg_dump -U postgres flashlist_db > backup_$(date +%Y%m%d_%H%M%S).sql
```

---

## 扩展字段（未来版本）

为了便于将来扩展，可预留以下字段：

```sql
ALTER TABLE flash_list_items
ADD COLUMN tags JSON COMMENT '标签列表（JSON数组）',
ADD COLUMN due_date BIGINT COMMENT '截止日期时间戳（毫秒）',
ADD COLUMN priority TINYINT DEFAULT 0 COMMENT '优先级 (0-4)',
ADD COLUMN parent_id VARCHAR(36) COMMENT '父任务ID（用于子任务关系）',
ADD COLUMN notes TEXT COMMENT '备注信息';
```

---

## PostgreSQL 版本

如果使用PostgreSQL，表结构调整如下：

```sql
CREATE TABLE flash_list_items (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL,
  text TEXT NOT NULL DEFAULT '',
  completed BOOLEAN NOT NULL DEFAULT FALSE,
  level SMALLINT NOT NULL DEFAULT 0 CHECK (level >= 0 AND level <= 4),
  type VARCHAR(10) NOT NULL DEFAULT 'task' CHECK (type IN ('task', 'header')),
  order_index NUMERIC(10, 2) NOT NULL CHECK (order_index >= 0),
  created_at BIGINT NOT NULL,
  updated_at BIGINT NOT NULL,
  deleted_at BIGINT DEFAULT NULL,

  CONSTRAINT fk_user FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
);

CREATE INDEX idx_user_order ON flash_list_items(user_id, order_index);
CREATE INDEX idx_user_type ON flash_list_items(user_id, type);
CREATE INDEX idx_created_at ON flash_list_items(created_at);
CREATE INDEX idx_deleted_at ON flash_list_items(deleted_at);
```

---

## 版本历史

| 版本 | 日期 | 说明 |
|------|------|------|
| v1.0 | 2025-12-23 | 初始版本，包含核心表结构 |
