# 登录失败问题修复说明

## 问题原因

部署到服务器后登录失败的原因：
1. 缺少 `.env` 环境变量配置文件
2. Docker 容器中的数据库没有测试用户
3. 数据库文件存储目录未创建

## 已修复的内容

### 1. 创建了 .env 文件
- 位置: 项目根目录
- 包含 JWT_SECRET 和 CORS_ORIGIN 配置
- **重要**: 生产环境请修改 JWT_SECRET 为安全的随机字符串

### 2. 创建了 seed 脚本
- 位置: `flashlist-backend/prisma/seed.ts`
- 功能: 自动创建测试用户

### 3. 更新了 Dockerfile
- 在容器启动时自动运行 seed 脚本
- 确保测试用户存在

### 4. 创建了必要的目录
- `data/` - 存储数据库文件
- `logs/backend/` - 后端日志
- `logs/frontend/` - 前端日志

## 重新部署步骤

### 方法一：使用部署脚本（推荐）

```bash
# 给脚本添加执行权限
chmod +x deploy.sh

# 运行部署脚本
./deploy.sh
```

### 方法二：手动部署

```bash
# 1. 停止现有容器
docker compose down

# 2. 重新构建镜像
docker compose build

# 3. 启动服务
docker compose up -d

# 4. 查看日志确认启动成功
docker compose logs -f
```

## 测试账户信息

部署成功后，使用以下账户登录：

- **邮箱**: test@example.com
- **密码**: password123

## 验证部署

### 1. 检查服务状态

```bash
# 查看所有服务
docker compose ps

# 应该看到两个服务都在运行：
# - flashlist-backend (端口 3001)
# - flashlist-frontend (端口 80)
```

### 2. 检查后端健康

```bash
# 测试后端健康检查
curl http://localhost:3001/health

# 应该返回：
# {"status":"ok","timestamp":...}
```

### 3. 检查数据库

```bash
# 查看数据库文件
ls -la data/

# 应该看到 prod.db 文件
```

### 4. 查看日志

```bash
# 查看后端日志，确认 seed 脚本运行成功
docker compose logs backend | grep "测试用户"

# 应该看到类似输出：
# ✅ 测试用户创建成功
# 或
# ⚠️  测试用户已存在，跳过创建
```

## 故障排查

### 问题1: 容器启动失败

```bash
# 查看详细错误
docker compose logs backend
docker compose logs frontend
```

### 问题2: 数据库错误

```bash
# 删除数据重新开始
docker compose down -v
rm -rf data/*
docker compose up -d
```

### 问题3: 仍然无法登录

1. 检查浏览器控制台的错误信息
2. 检查后端日志: `docker compose logs backend`
3. 手动进入容器检查:

```bash
# 进入后端容器
docker compose exec backend sh

# 检查数据库
cd /app/data
ls -la

# 检查 Prisma
npx prisma studio
```

### 问题4: CORS 错误

如果部署到实际服务器（非 localhost），需要修改 `.env` 文件：

```bash
# 修改 CORS_ORIGIN 为你的域名
CORS_ORIGIN=https://your-domain.com
```

然后重新部署：

```bash
docker compose down
docker compose up -d
```

## 生产环境注意事项

### 1. 修改 JWT_SECRET

```bash
# 生成安全的随机字符串
node -e "console.log(require('crypto').randomBytes(32).toString('hex'))"

# 将生成的字符串替换 .env 中的 JWT_SECRET
```

### 2. 配置 CORS_ORIGIN

如果使用域名访问，修改 `.env`:

```
CORS_ORIGIN=https://your-domain.com
```

### 3. 配置 HTTPS

参考 `部署指南.md` 中的 HTTPS 配置章节。

### 4. 定期备份数据

```bash
# 备份数据库
cp -r data backups/data-$(date +%Y%m%d)
```

## 下一步

部署成功后，你可以：

1. 使用测试账户登录验证功能
2. 注册新账户
3. 创建自己的待办事项
4. 配置域名和 HTTPS（生产环境）

---

如有问题，请查看：
- `docker compose logs` - 查看详细日志
- `README-DEPLOY.md` - 快速部署指南
- `部署指南.md` - 完整部署文档
